@WebMvcTest(PalServiceDevRestController.class)
class PalServiceDevRestControllerMockMvcTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private PalApiControllerAdvice advice;

    /**
     * A static inner subclass used ONLY for testing.
     * It replaces the real controller bean.
     */
    @TestConfiguration
    static class TestConfig {

        @Bean
        @Primary
        PalServiceDevRestController testController() {
            return new TestPalServiceDevRestController();
        }

        static class TestPalServiceDevRestController extends PalServiceDevRestController {

            // This will be injected from test
            @SuppressWarnings("rawtypes")
            static PalServiceRequest MOCK;

            @Override
            @SuppressWarnings("unchecked")
            protected <T extends PalGenericModel, R> PalServiceRequest<T, R>
            createPalServiceRequest(String apiName, PalMapModel input) {
                return MOCK; // return static mock stored in test
            }
        }
    }

    @Test
    void testService_withMockMvc_andStaticFactoryOverride() throws Exception {

        String apiName = "testApi";
        String body = "{ \"key\": \"value\" }";

        // Mock model returned by mapping
        PalGenericModel mockModel = mock(PalGenericModel.class);

        try (MockedStatic<PalServiceModelMapping> staticMock =
                     Mockito.mockStatic(PalServiceModelMapping.class)) {

            staticMock.when(() -> PalServiceModelMapping.getModel(eq(apiName), any()))
                      .thenReturn(mockModel);

            // Mock PalServiceResponse (abstract)
            PalServiceResponse<Object> mockResponse = mock(PalServiceResponse.class);

            // Mock PalServiceRequest & return response
            @SuppressWarnings("unchecked")
            PalServiceRequest<PalGenericModel, Object> mockRequest =
                    (PalServiceRequest<PalGenericModel, Object>) mock(PalServiceRequest.class);

            when(mockRequest.execute4api())
                    .thenReturn(ResponseEntity.ok(mockResponse));

            // store the mock in our static field inside inner controller
            TestConfig.TestPalServiceDevRestController.MOCK = mockRequest;

            // call endpoint
            mockMvc.perform(
                    post("/api/{apiName}/service", apiName)
                            .contentType(MediaType.APPLICATION_JSON)
                            .content(body)
            )
            .andExpect(status().isOk());

            // verify behavior
            staticMock.verify(() -> PalServiceModelMapping.getModel(eq(apiName), any()));
            verify(mockRequest).execute4api();
        }
    }
}
