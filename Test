package com.your.package; // <-- CHANGE this to the actual package of PalAbstractRestClient

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.lang.reflect.Method;
import java.util.*;

import com.jayway.jsonpath.JsonPath;
import org.junit.jupiter.api.*;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

class PalAbstractRestClientTest {

    private PalAbstractRestClient<Object, Object> client;

    @BeforeEach
    void setUp() {
        // concrete anonymous subclass to satisfy abstract methods
        client = new PalAbstractRestClient<>() {
            @Override
            protected HttpMethod httpMethod(final PalRestClientRequest<Object, Object> webRequest) {
                return HttpMethod.GET;
            }

            @Override
            protected java.util.List<PalGenericCodeModel> handleClientErrorResponse(final PalRestClientRequest<Object, Object> serviceRequest,
                                                                                   final byte[] rawBytes,
                                                                                   final HttpStatus httpStatus) {
                return Collections.emptyList();
            }
        };
    }

    @Test
    void evaluateMappedHeader_transactionId_currentTimestamp_epochTime_and_env() throws Exception {
        Method m = PalAbstractRestClient.class.getDeclaredMethod("evaluateMappedHeader", String.class);
        m.setAccessible(true);

        // transactionId -> UUID
        String txn = (String) m.invoke(client, "transactionId");
        assertNotNull(txn);
        assertDoesNotThrow(() -> java.util.UUID.fromString(txn));

        // currentTimestamp -> parseable Instant string
        String ts = (String) m.invoke(client, "currentTimestamp");
        assertNotNull(ts);
        java.time.Instant.parse(ts); // will throw if invalid

        // epochTime -> digits
        String epoch = (String) m.invoke(client, "epochTime");
        assertNotNull(epoch);
        assertTrue(epoch.matches("\\d+"));

        // fallback -> system property
        System.setProperty("TEST_PROP_FOR_PAL", "prop-val");
        String propVal = (String) m.invoke(client, "TEST_PROP_FOR_PAL");
        assertEquals("prop-val", propVal);
    }

    @Test
    void createUriParams_usesTransactionalObjects_and_jsonPathFallback() {
        // Arrange
        PalRestClientRequest<Object, Object> req = mock(PalRestClientRequest.class);
        PalRestClientServiceDefinition svc = mock(PalRestClientServiceDefinition.class);

        when(svc.getUri()).thenReturn("/users/{userId}/orders/{orderId}");
        when(req.getServiceDefinition()).thenReturn(svc);

        Map<String, Object> tx = new HashMap<>();
        tx.put("userId", "user-42");
        when(req.getTransactionalObjects()).thenReturn(tx);

        when(req.getUriParameters()).thenReturn(null);

        String requestJson = "{\"payload\":{\"orderId\":\"order-999\"}}";
        when(req.getRequest()).thenReturn(requestJson);

        // Mock JsonPath.read(...) static call used inside createUriParams
        try (MockedStatic<JsonPath> jsonPathStatic = Mockito.mockStatic(JsonPath.class)) {
            jsonPathStatic.when(() -> JsonPath.read(requestJson, "$..orderId"))
                    .thenReturn(Collections.singletonList("order-999"));

            // Act
            Map<String, Object> params = client.createUriParams(req);

            // Assert
            assertEquals("user-42", params.get("userId"));
            assertEquals("order-999", params.get("orderId"));
        }
    }

    @Test
    void buildHttpHeaders_setsAcceptAndContentAndMappingHeaders() {
        // Arrange
        PalRestClientRequest<Object, Object> req = mock(PalRestClientRequest.class);
        PalRestClientServiceDefinition svc = mock(PalRestClientServiceDefinition.class);
        PalRestClientHostDefinition host = mock(PalRestClientHostDefinition.class);

        when(req.getServiceDefinition()).thenReturn(svc);
        when(req.getHostDefinition()).thenReturn(host);

        when(svc.getProduces()).thenReturn(MediaType.APPLICATION_JSON_VALUE);
        when(svc.getConsumes()).thenReturn(MediaType.APPLICATION_JSON_VALUE);

        Map<String, String> mapped = new HashMap<>();
        mapped.put("apikey", "{{transactionId}}");
        mapped.put("x-client", "client-100");

        // spy to stub createHeaderParameter without requiring other header classes
        PalAbstractRestClient<Object, Object> spyClient = spy(client);
        doReturn(mapped).when(spyClient).createHeaderParameter(any());

        // Act
        HttpHeaders headers = spyClient.buildHttpHeaders(req);

        // Assert accept/content-type
        assertTrue(headers.getAccept().contains(MediaType.APPLICATION_JSON));
        assertEquals(MediaType.APPLICATION_JSON, headers.getContentType());

        // Check apikey generated (transactionId -> UUID-like)
        String apiKey = headers.getFirst("apikey");
        assertNotNull(apiKey);
        assertFalse(apiKey.isBlank());
        // basic UUID format check (len 36 with dashes)
        assertTrue(apiKey.matches("[0-9a-fA-F\\-]{36}"), "apikey should resemble a UUID");

        // direct header retained
        assertEquals("client-100", headers.getFirst("x-client"));
    }

    @Test
    void buildHttpEntity_withBodyAndHeaders_returnsHttpEntity() {
        // Arrange
        PalRestClientRequest<Object, Object> req = mock(PalRestClientRequest.class);
        PalAbstractRestClient<Object, Object> spyClient = spy(client);

        Map<String, String> body = Map.of("a", "b");
        doReturn(body).when(spyClient).createHttpBody(any());

        HttpHeaders hdrs = new HttpHeaders();
        hdrs.set("h1", "v1");
        doReturn(hdrs).when(spyClient).buildHttpHeaders(any());

        // Act
        HttpEntity<?> ent = spyClient.buildHttpEntity(req);

        // Assert
        assertNotNull(ent);
        assertEquals(body, ent.getBody());
        assertEquals("v1", ent.getHeaders().getFirst("h1"));
    }

    @Test
    void transformClientResponse_handlesJsonResponse_and_setsResultAndStatus() {
        // Arrange
        PalRestClientRequest<Object, Object> req = mock(PalRestClientRequest.class);
        PalRestClientResponseModel<Object> respModel = mock(PalRestClientResponseModel.class);

        when(req.getResponse()).thenReturn(respModel);
        // simulate responseType() returning a String class for simplicity
        when(req.responseType()).thenReturn((Class<Object>) (Class) String.class);
        when(req.getMediaType()).thenReturn(MediaType.APPLICATION_JSON);
        // default result keys - can be null
        when(req.getResultKeys()).thenReturn(null);

        String json = "{\"data\":{\"name\":\"john\"},\"totalCount\":5}";
        byte[] raw = json.getBytes();

        // Mock PalJsonUtils static methods used in transformJsonResponse
        try (MockedStatic<PalJsonUtils> palJson = Mockito.mockStatic(PalJsonUtils.class)) {
            // when withObjectMapper is called, return a real ObjectMapper (or mock)
            palJson.when(PalJsonUtils::withObjectMapper).thenReturn(new com.fasterxml.jackson.databind.ObjectMapper());
            // pathReadFromJsonString(...) - return null (so code will go to readValue branch)
            palJson.when(() -> PalJsonUtils.pathReadFromJsonString(anyString(), any()))
                    .thenReturn(null);
            // readValue(...) should return a parsed object; return a known marker
            palJson.when(() -> PalJsonUtils.readValue(eq(json), any(com.fasterxml.jackson.databind.JavaType.class)))
                    .thenReturn((Object) "PARSED_PAYLOAD");

            // Act
            client.transformClientResponse(req, HttpStatus.OK, raw);

            // Verify responseModel.setResult called with PARSED_PAYLOAD and http status set to OK
            verify(respModel).setResult("PARSED_PAYLOAD");
            verify(respModel).setHttpStatus(HttpStatus.OK);
        }
    }
}
