// package your.package.here;

import static org.junit.jupiter.api.Assertions.assertSame;
import static org.mockito.Mockito.when;

import java.util.Collections;
import java.util.Map;

import org.junit.jupiter.api.Test;
import org.mockito.MockedConstruction;
import org.mockito.MockedStatic;
import org.mockito.Mockito;
import org.springframework.http.ResponseEntity;

class PalServiceDevRestControllerTest {

    @Test
    void service_shouldCreatePalServiceRequestAndReturnItsResponse() {
        // Arrange
        PalServiceDevRestController controller = new PalServiceDevRestController();

        String apiName = "testApi";
        PalMapModel input = new PalMapModel();
        Map<String, String> headers = Collections.singletonMap("X-REQUEST-ID", "1234");

        // Mock the model mapping
        PalGenericModel mappedModel = Mockito.mock(PalGenericModel.class);

        // Mock the response returned from execute4api()
        @SuppressWarnings("unchecked")
        PalServiceResponse<String> palResponse = Mockito.mock(PalServiceResponse.class);
        ResponseEntity<PalServiceResponse<String>> expectedResponse =
                ResponseEntity.ok(palResponse);

        try (
            // 1. Mock static method PalServiceModelMapping.getModel(...)
            MockedStatic<PalServiceModelMapping> mappingMock =
                    Mockito.mockStatic(PalServiceModelMapping.class);

            // 2. Mock construction of PalServiceRequest (including the anonymous subclass)
            MockedConstruction<PalServiceRequest> requestConstruction =
                    Mockito.mockConstruction(
                            PalServiceRequest.class,
                            (mock, context) -> {
                                // Verify constructor args
                                // new PalServiceRequest(apiName, PalServiceModelMapping.getModel(apiName, input))
                                // context.arguments().get(0) -> apiName
                                // context.arguments().get(1) -> mappedModel
                                org.junit.jupiter.api.Assertions.assertEquals(apiName, context.arguments().get(0));
                                org.junit.jupiter.api.Assertions.assertEquals(mappedModel, context.arguments().get(1));

                                // Stub execute4api() to return our expected ResponseEntity
                                @SuppressWarnings("unchecked")
                                PalServiceRequest<PalGenericModel, String> typedMock =
                                        (PalServiceRequest<PalGenericModel, String>) mock;
                                when(typedMock.execute4api()).thenReturn(expectedResponse);
                            })
        ) {
            // Arrange static method behavior
            mappingMock
                .when(() -> PalServiceModelMapping.getModel(apiName, input))
                .thenReturn(mappedModel);

            // Act
            ResponseEntity<PalServiceResponse<String>> actualResponse =
                    controller.service(headers, apiName, input);

            // Assert
            assertSame(expectedResponse, actualResponse,
                    "Controller should return the ResponseEntity from PalServiceRequest.execute4api()");

            // Verify static method usage
            mappingMock.verify(() -> PalServiceModelMapping.getModel(apiName, input));
        }
    }
}
