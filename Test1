// package com.cox.pal.serv.rest;

import com.cox.oss.prov.pal.model.PalGenericModel;
import com.cox.oss.prov.pal.model.PalMapModel;
import com.cox.oss.prov.pal.model.service.PalServiceRequest;
import com.cox.oss.prov.pal.model.service.PalServiceResponse;
import com.cox.oss.prov.pal.model.service.PalServiceModelMapping;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mockito;
import org.springframework.http.ResponseEntity;
import org.powermock.api.mockito.PowerMockito;
import org.powermock.core.classloader.annotations.PrepareForTest;
import org.powermock.modules.junit4.PowerMockRunner;

import java.util.Collections;
import java.util.Map;

import static org.junit.Assert.assertSame;
import static org.mockito.Mockito.verify;

@RunWith(PowerMockRunner.class)
@PrepareForTest({
        PalServiceDevRestController.class,
        PalServiceModelMapping.class,   // for static mocking
        PalServiceRequest.class         // for constructor mocking (optional but safe)
})
public class PalServiceDevRestControllerTest {

    @Test
    @SuppressWarnings("unchecked")
    public void service_shouldCreatePalServiceRequestAndReturnItsResponse() throws Exception {
        // Arrange
        PalServiceDevRestController controller = new PalServiceDevRestController();

        String apiName = "testApi";
        PalMapModel input = new PalMapModel();
        Map<String, String> headers = Collections.singletonMap("X-REQUEST-ID", "1234");

        // 1. Mock static PalServiceModelMapping.getModel(...)
        PowerMockito.mockStatic(PalServiceModelMapping.class);

        PalGenericModel mappedModel = Mockito.mock(PalGenericModel.class);
        PowerMockito
                .when(PalServiceModelMapping.getModel(apiName, input))
                .thenReturn(mappedModel);

        // 2. Mock construction of PalServiceRequest(apiName, mappedModel)
        PalServiceRequest<PalGenericModel, String> requestMock =
                PowerMockito.mock(PalServiceRequest.class);

        PowerMockito
                .whenNew(PalServiceRequest.class)
                .withArguments(apiName, mappedModel)
                // the controller creates new PalServiceRequest<T, R>(apiName, model) { }
                // PowerMockito will match it as PalServiceRequest.class
                .thenReturn(requestMock);

        // 3. Stub execute4api() to return a known ResponseEntity
        PalServiceResponse<String> palServiceResponseMock = Mockito.mock(PalServiceResponse.class);
        ResponseEntity<PalServiceResponse<String>> expectedResponse =
                ResponseEntity.ok(palServiceResponseMock);

        Mockito
                .when(requestMock.execute4api())
                .thenReturn(expectedResponse);

        // Act
        ResponseEntity<PalServiceResponse<String>> actualResponse =
                controller.service(headers, apiName, input);

        // Assert
        assertSame("Controller should return the ResponseEntity from PalServiceRequest.execute4api()",
                expectedResponse, actualResponse);

        // Verify static and constructor interactions
        PowerMockito.verifyStatic(PalServiceModelMapping.class);
        PalServiceModelMapping.getModel(apiName, input);

        PowerMockito.verifyNew(PalServiceRequest.class)
                    .withArguments(apiName, mappedModel);

        verify(requestMock).execute4api();
    }
}
